<html>
    <head>
        <script>
            window.addEventListener("message", async (event) => {
                if (event.origin != "{{.Frontend}}") {
                    return
                }

                handleEncode = async (event) => {
                    var payload = event.data.payload
                    var reply = { requestId: event.data.requestId, type: "encoded", payload: payload }
                    
                    try {
                        var response = await fetch("{{.BasePath}}/encode", { method: "POST", body: JSON.stringify(payload) })
                        if (response.ok) {
                            reply.payload = await response.json()
                        } else {
                            reply.error = await response.text()
                        }
                    } catch (e) {
                        reply.error = e
                    }
                    event.source.postMessage(reply, { targetOrigin: "{{.Frontend}}" })
                }

                handleDecode = async (event) => {
                    var payload = event.data.payload
                    var reply = { requestId: event.data.requestId, type: "decoded", payload: payload }

                    try {
                        var response = await fetch("{{.BasePath}}/decode", { method: "POST", body: JSON.stringify(payload) })
                        if (response.ok) {
                            reply.payload = await response.json()
                        } else {
                            reply.error = await response.text()
                        }
                    } catch (e) {
                        reply.error = e
                    }
                    event.source.postMessage(reply, { targetOrigin: "{{.Frontend}}" })
                }

                switch (event.data.type) {
                    case "encode":
                        handleEncode(event)
                        break;
                    case "decode":
                        handleDecode(event)
                        break;
                }
            })

            window.parent.postMessage({ type: "data_encoder_ready" }, "{{.Frontend}}")
        </script>
    </head>
</html>